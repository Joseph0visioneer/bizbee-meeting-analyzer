import { NextRequest, NextResponse } from 'next/server'
import Anthropic from '@anthropic-ai/sdk'

const anthropic = new Anthropic({
  apiKey: process.env.ANTHROPIC_API_KEY,
})

// 분석 템플릿들
const ANALYSIS_TEMPLATES = {
  three_levels_listening: `
당신은 전문적인 미팅 분석가입니다. 제공된 미팅 대화를 3단계 리스닝 분석 방법론을 사용하여 분석해주세요.

## 3단계 리스닝 분석이란?
- **Level 1: 내부적 듣기** - 자신의 관점에서 듣고 판단하는 것
- **Level 2: 집중적 듣기** - 상대방에게 완전히 집중하여 그들의 관점을 이해하는 것  
- **Level 3: 글로벌 듣기** - 전체적인 맥락, 분위기, 에너지를 포착하는 것

다음 미팅 대화를 분석해주세요:

{MEETING_CONTENT}

# 미팅 분석 보고서 - 3단계 리스닝

## 📊 미팅 개요
- **분석 일시**: {CURRENT_DATE}
- **예상 참석자 수**: [자동 추정]
- **미팅 지속 시간**: [추정]

## 🎯 Level 1: 내부적 듣기 (Internal Listening)
### 주요 발견사항
- 각 참석자들의 개인적 관점과 입장
- 개별 이해관계 및 우선순위
- 개인적 편견이나 선입견이 드러나는 부분

### 핵심 인사이트
[각 참석자의 내부적 관점 분석]

## 👥 Level 2: 집중적 듣기 (Focused Listening)  
### 상호작용 분석
- 참석자들 간의 소통 패턴
- 서로에 대한 이해도와 공감 수준
- 질문과 응답의 품질

### 핵심 인사이트
[참석자들이 서로를 어떻게 듣고 있는지 분석]

## 🌐 Level 3: 글로벌 듣기 (Global Listening)
### 전체적 맥락 분석
- 미팅의 전반적인 분위기와 에너지
- 숨겨진 의도나 맥락
- 조직/팀 차원의 역학 관계

### 핵심 인사이트
[전체적인 시스템과 환경의 관점에서 분석]

## 📋 종합 분석 및 권고사항

### 🔍 주요 발견사항
1. **커뮤니케이션 강점**
2. **개선이 필요한 영역** 
3. **놓치고 있는 관점들**

### 💡 실행 제안
1. **즉시 실행할 수 있는 것들**
2. **중장기적으로 개선할 것들**
3. **다음 미팅에서 시도할 것들**

### 🎯 다음 미팅을 위한 준비사항
- 사전 준비 항목
- 토론 주제 제안
- 참석자별 준비 요청 사항

---
*이 분석은 3단계 리스닝 방법론을 기반으로 AI가 자동 생성한 것입니다.*
`,

  mece_framework: `
당신은 맥킨지 앤 컴퍼니의 시니어 컨설턴트입니다. 제공된 미팅 내용을 MECE(Mutually Exclusive, Collectively Exhaustive) 프레임워크를 활용하여 엘리트 컨설팅 수준의 깊이 있는 분석을 수행해주세요.

## 🏛️ MECE 프레임워크 핵심 원칙
- **Mutually Exclusive (상호 배타성)**: 각 카테고리가 독립적이며 명확하게 구분됨
- **Collectively Exhaustive (집합적 포괄성)**: 전체 범위를 빠짐없이 체계적으로 커버
- **Strategic Decomposition**: 문제를 논리적 계층구조로 분해하여 전략적 통찰 도출

다음 미팅 대화를 분석해주세요:

{MEETING_CONTENT}

# 🎯 엘리트 컨설팅 미팅 분석 - MECE 프레임워크

## 📊 Executive Summary & 미팅 개요
- **분석 일시**: {CURRENT_DATE}
- **분석 방법론**: McKinsey MECE Framework
- **참석자 추정**: [역할별 참석자 분석]
- **미팅 목적**: [Primary & Secondary Objectives 도출]
- **핵심 의사결정**: [주요 결정사항 요약]

## 🔍 Phase 1: 문제 구조 설계 (Problem Structure Design)

### 핵심 이슈 식별 (Issue Tree Analysis)
**주요 문제 정의**: [미팅에서 다뤄진 핵심 문제]
**문제 범위**: [Boundary 설정 및 제약사항]
**이해관계자 영향도**: [Stakeholder Impact Assessment]

### 분해 접근법 적용 (Decomposition Strategy)
- **기능적 분해**: [프로세스/시스템 기능별 분류]
- **구조적 분해**: [조직/지역/제품별 분류]  
- **시간적 분해**: [단계별/생명주기별 분류]
- **개념적 분해**: [논리적 카테고리별 분류]

## 🎯 Phase 2: 3차원 MECE 분석 매트릭스

### 🚀 전략적 차원 (Strategic Dimension)
#### Level 1: 시장 포지셔닝 & 경쟁우위
- **시장 기회 분석**: [새로운 시장 기회 및 위협 요소]
- **경쟁 우위 전략**: [Cost Leadership vs Differentiation vs Focus Strategy]
- **가치 제안 재정의**: [고객 가치 사슬 분석 기반 재정의]
- **파트너십 전략**: [전략적 제휴 및 협업 기회]

#### Level 2: 혁신 & 성장 엔진
- **비즈니스 모델 혁신**: [수익 창출 메커니즘 혁신]
- **디지털 트랜스포메이션**: [기술 활용 전략]
- **신사업 기회**: [인접 시장 진출 전략]
- **M&A 및 투자**: [외부 성장 기회]

### ⚙️ 운영적 차원 (Operational Dimension)  
#### Level 1: 프로세스 최적화
- **워크플로우 효율성**: [프로세스 개선 기회 및 방안]
- **품질 관리 체계**: [품질 향상을 위한 시스템 구축]
- **비용 구조 최적화**: [Cost Structure Analysis & Optimization]
- **공급망 관리**: [Supply Chain 효율화 방안]

#### Level 2: 리소스 관리 & 성과
- **인력 최적 배치**: [Talent Allocation & Productivity Enhancement]
- **예산 배분 전략**: [Resource Allocation based on ROI]
- **기술 인프라**: [Technology Infrastructure Optimization]
- **성과 측정 체계**: [KPI Framework & Performance Management]

### 👥 조직적 차원 (Organizational Dimension)
#### Level 1: 인적 자원 & 역량
- **핵심 인재 관리**: [Talent Acquisition, Development & Retention]
- **역량 개발 체계**: [Competency Framework & Learning Path]
- **조직 문화 혁신**: [Culture Transformation Initiatives]
- **리더십 파이프라인**: [Leadership Development & Succession]

#### Level 2: 거버넌스 & 운영 체계
- **의사결정 체계**: [Decision-Making Process & Authority Matrix]
- **책임 할당 구조**: [RACI Matrix & Accountability Framework]
- **커뮤니케이션 체계**: [Information Flow & Communication Protocol]
- **변화 관리**: [Change Management Strategy & Implementation]

## 📋 고급 의사결정 분석 매트릭스

### 결정사항 Impact-Effort 분석
| 결정사항 | 분류 | Impact (High/Medium/Low) | Effort (High/Medium/Low) | 우선순위 | 담당자 | 실행 기한 | 성공 지표 |
|----------|------|--------------------------|--------------------------|----------|--------|-----------|-----------|
| [결정 1] | 전략적 | [Impact 분석] | [Effort 분석] | [우선순위] | [담당자] | [기한] | [KPI] |
| [결정 2] | 운영적 | [Impact 분석] | [Effort 분석] | [우선순위] | [담당자] | [기한] | [KPI] |
| [결정 3] | 조직적 | [Impact 분석] | [Effort 분석] | [우선순위] | [담당자] | [기한] | [KPI] |

### 미결정 사항 Risk-Opportunity 분석  
| 이슈 | 위험도 | 기회도 | 분석 필요 영역 | 추가 정보 요구사항 | 다음 단계 | 결정 기한 |
|------|--------|--------|----------------|-------------------|-----------|-----------|
| [이슈 1] | [위험 분석] | [기회 분석] | [MECE 분석 영역] | [정보 갭] | [Next Steps] | [기한] |
| [이슈 2] | [위험 분석] | [기회 분석] | [MECE 분석 영역] | [정보 갭] | [Next Steps] | [기한] |

## 🔍 Phase 3: Gap Analysis & 전략적 통찰

### 다차원 격차 분석 (Multi-Dimensional Gap Analysis)

#### 현재 상태 vs 목표 상태 매트릭스
| 차원 | 현재 상태 | 목표 상태 | 격차 크기 | 해소 방안 | 필요 자원 | 예상 기간 |
|------|-----------|-----------|-----------|-----------|-----------|-----------|
| 전략적 | [현황] | [목표] | [Gap Size] | [Solution] | [Resources] | [Timeline] |
| 운영적 | [현황] | [목표] | [Gap Size] | [Solution] | [Resources] | [Timeline] |
| 조직적 | [현황] | [목표] | [Gap Size] | [Solution] | [Resources] | [Timeline] |

#### Root Cause Analysis (5-Why 기법 적용)
**주요 격차의 근본 원인**:
1. Why? [1차 원인]
2. Why? [2차 원인]  
3. Why? [3차 원인]
4. Why? [4차 원인]
5. Why? [근본 원인]

### 전략적 시나리오 분석
#### 시나리오 1: 최적 시나리오 (Best Case)
- **가정**: [주요 가정사항]
- **결과**: [예상 결과]
- **확률**: [발생 확률]

#### 시나리오 2: 현실적 시나리오 (Most Likely)
- **가정**: [주요 가정사항]
- **결과**: [예상 결과]  
- **확률**: [발생 확률]

#### 시나리오 3: 위험 시나리오 (Worst Case)
- **가정**: [주요 가정사항]
- **결과**: [예상 결과]
- **확률**: [발생 확률]

## 💡 전략적 권고사항 (Strategic Recommendations)

### 🚀 Tier 1: 즉시 실행 (Quick Wins) - 30일 내
1. **[권고 1]**: [구체적 실행 방안]
   - 예상 효과: [Impact Estimation]
   - 필요 리소스: [Resource Requirements]
   - 성공 지표: [Success Metrics]

2. **[권고 2]**: [구체적 실행 방안]
   - 예상 효과: [Impact Estimation]
   - 필요 리소스: [Resource Requirements]  
   - 성공 지표: [Success Metrics]

### ⚙️ Tier 2: 중기 전략 (Strategic Initiatives) - 3-6개월
1. **[전략 이니셔티브 1]**: [상세 계획]
   - 전략적 목표: [Strategic Objective]
   - 실행 로드맵: [Implementation Roadmap]
   - 위험 요소: [Risk Mitigation]

2. **[전략 이니셔티브 2]**: [상세 계획]
   - 전략적 목표: [Strategic Objective]
   - 실행 로드맵: [Implementation Roadmap]
   - 위험 요소: [Risk Mitigation]

### 🎯 Tier 3: 장기 비전 (Transformational) - 6개월 이상
1. **[변혁 프로그램 1]**: [비전 및 전략]
   - 변혁 목표: [Transformation Goal]
   - 성공 요인: [Critical Success Factors]
   - 변화 관리: [Change Management Plan]

2. **[변혁 프로그램 2]**: [비전 및 전략]  
   - 변혁 목표: [Transformation Goal]
   - 성공 요인: [Critical Success Factors]
   - 변화 관리: [Change Management Plan]

## 📊 실행 로드맵 & 모니터링 체계

### 통합 실행 계획
\`\`\`
Phase 1 (1개월) → Phase 2 (3-6개월) → Phase 3 (6-12개월)
      ↓                   ↓                    ↓
  [Quick Wins]     [Strategic Build]    [Transformation]
      ↓                   ↓                    ↓
  [즉시 개선]        [시스템 구축]         [비전 달성]
\`\`\`

### 성과 모니터링 대시보드
| 지표 유형 | KPI | 현재값 | 목표값 | 측정 주기 | 책임자 | 리포팅 방식 |
|-----------|-----|--------|--------|-----------|--------|-------------|
| 전략적 | [Strategic KPI] | [Current] | [Target] | [Frequency] | [Owner] | [Reporting] |
| 운영적 | [Operational KPI] | [Current] | [Target] | [Frequency] | [Owner] | [Reporting] |
| 조직적 | [Organizational KPI] | [Current] | [Target] | [Frequency] | [Owner] | [Reporting] |

---
*이 분석은 McKinsey MECE 프레임워크와 전략 컨설팅 방법론을 기반으로 생성된 엘리트급 분석 보고서입니다.*
`,

  pyramid_principle: `
당신은 바바라 민토의 피라미드 원리(The Pyramid Principle) 전문가이자 맥킨지 출신 시니어 컨설턴트입니다. 제공된 미팅 내용을 글로벌 컨설팅 펌 수준의 논리적 구조화와 커뮤니케이션 기법을 활용하여 엘리트급 분석을 수행해주세요.

## 🏛️ 피라미드 원리 핵심 철학
- **Answer-First Approach**: 결론을 먼저 제시하여 30초 내 핵심 전달
- **SCQA 스토리텔링**: Situation-Complication-Question-Answer 구조로 논리적 흐름 구축
- **MECE 기반 그룹핑**: 상호배타적이며 집합적으로 완전한 논리 구조
- **Top-Down Communication**: 독자 정신 에너지 절약을 위한 계층적 정보 전달

다음 미팅 대화를 분석해주세요:

{MEETING_CONTENT}

# 🎯 글로벌 컨설팅 미팅 분석 - 피라미드 원리

## 📊 Executive Summary (Answer-First)

### 🔥 30초 핵심 메시지 (Elevator Pitch)
**주요 결론**: [미팅의 핵심 결론을 한 문장으로 임팩트 있게]

### ⚡ Key Takeaways (3-Point Summary)
1. **[핵심 포인트 1]**: [핵심 인사이트 요약]
2. **[핵심 포인트 2]**: [핵심 인사이트 요약]
3. **[핵심 포인트 3]**: [핵심 인사이트 요약]

### 📈 Bottom Line Impact
- **비즈니스 임팩트**: [예상 효과/수치]
- **결정 시급성**: [High/Medium/Low + 이유]
- **리소스 필요도**: [High/Medium/Low + 규모]

## 🔍 SCQA 스토리텔링 분석 (서론 구성)

### 📍 Situation (상황 설정)
**배경 컨텍스트**: [비논쟁적 사실 1-2문장으로 설정]
- 현재 비즈니스 환경: [시장/조직 상황]
- 관련 이해관계자: [주요 참석자 역할 분석]
- 미팅 발생 배경: [왜 이 미팅이 필요했는가]

### ⚠️ Complication (문제/변화 발생)
**핵심 도전과제**: [해결이 필요한 문제나 기회]
- 변화 요인: [내/외부 변화 동인]
- 문제의 영향도: [비즈니스에 미치는 영향]
- 시간적 제약: [의사결정 타임라인]
- 이해관계 갈등: [다양한 관점과 우선순위]

### ❓ Question (핵심 질문 도출)
**해결해야 할 핵심 질문**: [미팅에서 답해야 할 근본적 질문]
- Primary Question: [가장 중요한 질문]
- Secondary Questions: [부수적 질문들]
- Hidden Questions: [명시되지 않은 암묵적 질문들]

### ✅ Answer (해답 제시)
**제시된 솔루션**: [미팅에서 도출된 답변]
- 권장 방향: [추천하는 해결책]
- 대안 옵션: [고려된 다른 선택지들]
- 합의 수준: [참석자들의 동의 정도]

## 🏗️ 피라미드 구조 분석 (3-Level Hierarchy)

### 🔝 Level 1: 핵심 메시지 (Apex Message)
**통합 결론**: [모든 논거를 통합한 최종 메시지]

### 🎯 Level 2: 주요 지지 논거 (Key Supporting Points)
**MECE 원칙 적용 - 3-4개 핵심 그룹**

#### 🚀 논거 그룹 1: [첫 번째 주요 근거 카테고리]
**그룹 요약**: [이 그룹의 핵심 메시지]
- **핵심 증거 A**: [구체적 사실/데이터/사례]
- **핵심 증거 B**: [구체적 사실/데이터/사례]  
- **핵심 증거 C**: [구체적 사실/데이터/사례]
- **So What?**: [이 그룹이 주장하는 바]

#### ⚙️ 논거 그룹 2: [두 번째 주요 근거 카테고리]  
**그룹 요약**: [이 그룹의 핵심 메시지]
- **핵심 증거 A**: [구체적 사실/데이터/사례]
- **핵심 증거 B**: [구체적 사실/데이터/사례]
- **핵심 증거 C**: [구체적 사실/데이터/사례]
- **So What?**: [이 그룹이 주장하는 바]

#### 💼 논거 그룹 3: [세 번째 주요 근거 카테고리]
**그룹 요약**: [이 그룹의 핵심 메시지]
- **핵심 증거 A**: [구체적 사실/데이터/사례]
- **핵심 증거 B**: [구체적 사실/데이터/사례]
- **핵심 증거 C**: [구체적 사실/데이터/사례]
- **So What?**: [이 그룹이 주장하는 바]

#### 🎪 논거 그룹 4: [네 번째 주요 근거 카테고리 - 필요시]
**그룹 요약**: [이 그룹의 핵심 메시지]
- **핵심 증거 A**: [구체적 사실/데이터/사례]
- **핵심 증거 B**: [구체적 사실/데이터/사례]
- **핵심 증거 C**: [구체적 사실/데이터/사례]
- **So What?**: [이 그룹이 주장하는 바]

## 🧠 논리적 추론 분석 (Logical Reasoning)

### 🔄 귀납적 추론 (Inductive Reasoning)
**패턴 인식 및 결론 도출**: [유사한 사실들로부터 일반화된 통찰]
- 관찰된 패턴: [미팅에서 나타난 공통 패턴들]
- 일반화 결론: [패턴으로부터 도출한 일반적 결론]
- 적용 범위: [이 결론이 적용될 수 있는 범위]
- 제한 사항: [일반화의 한계점]

### 🎯 연역적 추론 (Deductive Reasoning)
**논리적 결론 도출**: [전제로부터 논리적으로 도출한 결론]
- 주요 전제: [받아들여진 기본 가정들]
- 보조 전제: [추가적 조건이나 사실들]
- 논리적 결론: [전제들로부터 필연적으로 도출되는 결론]
- 타당성 검증: [논리적 흐름의 타당성]

### 🔗 인과관계 분석 (Cause-Effect Analysis)
**원인-결과 메커니즘**: [미팅에서 논의된 인과관계]
- 근본 원인: [문제의 본질적 원인]
- 직접 원인: [즉각적인 발생 원인]
- 예상 결과: [조치 시 예상되는 결과]
- 부작용: [의도치 않은 결과 가능성]

## 💡 전략적 의사결정 분석

### 🎯 결정 옵션 평가 매트릭스
| 옵션 | 예상효과 | 실행난이도 | 리스크 | 타임라인 | 비용 | 추천도 | 핵심 근거 |
|------|----------|------------|--------|----------|------|--------|-----------|
| [옵션 A] | [High/Med/Low] | [High/Med/Low] | [High/Med/Low] | [기간] | [비용] | ⭐⭐⭐⭐⭐ | [선택 이유] |
| [옵션 B] | [High/Med/Low] | [High/Med/Low] | [High/Med/Low] | [기간] | [비용] | ⭐⭐⭐⭐☆ | [선택 이유] |
| [옵션 C] | [High/Med/Low] | [High/Med/Low] | [High/Med/Low] | [기간] | [비용] | ⭐⭐⭐☆☆ | [선택 이유] |

### 🏆 권장 솔루션 (Recommended Solution)
**최적 선택안**: [분석을 통해 도출된 최선의 선택]
- **선택 근거**: [왜 이 옵션이 최적인가]
- **성공 조건**: [성공을 위한 핵심 요소들]
- **위험 완화**: [주요 위험과 대응방안]
- **성과 지표**: [성공 측정을 위한 KPI]

### 🚧 의사결정 트리 (Decision Tree)
\`\`\`
핵심 결정: [주요 의사결정]
├── 시나리오 A: [조건/상황 A]
│   ├── 결과 A1: [결과와 확률]
│   ├── 결과 A2: [결과와 확률]
│   └── 권장 액션: [추천 행동]
├── 시나리오 B: [조건/상황 B]
│   ├── 결과 B1: [결과와 확률]
│   ├── 결과 B2: [결과와 확률]  
│   └── 권장 액션: [추천 행동]
└── 최종 권장: [종합적 권장안]
    ├── 핵심 가치: [기대 가치]
    ├── 성공 확률: [성공 가능성]
    └── 실행 조건: [실행을 위한 전제조건]
\`\`\`

## 📊 실행 로드맵 (Implementation Roadmap)

### 🚀 Phase 1: 즉시 실행 (30일 내)
**Quick Wins & Foundation Building**
1. **[액션 1]**: [구체적 실행 내용]
   - 책임자: [담당자/팀]
   - 기대효과: [예상 결과]
   - 성공지표: [측정 방법]
   - 리스크: [잠재 위험]

2. **[액션 2]**: [구체적 실행 내용]
   - 책임자: [담당자/팀]
   - 기대효과: [예상 결과]
   - 성공지표: [측정 방법]
   - 리스크: [잠재 위험]

### ⚙️ Phase 2: 중기 실행 (3개월 내)
**System Building & Process Enhancement**
1. **[이니셔티브 1]**: [중기 프로젝트]
   - 전략적 목표: [달성하고자 하는 목표]
   - 핵심 마일스톤: [주요 중간 목표들]
   - 자원 요구사항: [필요 리소스]
   - 성공 조건: [성공을 위한 조건]

2. **[이니셔티브 2]**: [중기 프로젝트]
   - 전략적 목표: [달성하고자 하는 목표]
   - 핵심 마일스톤: [주요 중간 목표들]
   - 자원 요구사항: [필요 리소스]
   - 성공 조건: [성공을 위한 조건]

### 🎯 Phase 3: 장기 비전 (6-12개월)
**Transformation & Sustainable Growth**
1. **[변혁 프로그램]**: [장기 변화 계획]
   - 비전 목표: [궁극적 목표]
   - 변화 범위: [변화의 폭과 깊이]
   - 조직 임팩트: [조직에 미치는 영향]
   - 지속성 계획: [지속 가능성 확보 방안]

## 🎪 Next Steps & Follow-up Actions

### 📋 즉시 후속 조치 (Next 48 Hours)
1. **[긴급 조치 1]**: [즉시 해야 할 일]
2. **[긴급 조치 2]**: [즉시 해야 할 일]
3. **[긴급 조치 3]**: [즉시 해야 할 일]

### 📅 후속 미팅 제안
- **미팅 주제**: [다음 논의할 주제]
- **참석자**: [참여가 필요한 사람들]
- **아젠다**: [구체적 논의 사항]
- **기대 결과**: [미팅으로부터 기대하는 결과]

### 📊 진행 상황 모니터링
- **체크포인트**: [정기 점검 일정]
- **보고 방식**: [진행 상황 보고 방법]
- **의사결정 포인트**: [주요 결정이 필요한 시점들]

## 🏆 성공 측정 프레임워크

### 📈 Key Performance Indicators (KPI)
| KPI 카테고리 | 측정 지표 | 현재값 | 목표값 | 측정 주기 | 책임자 | 보고 대상 |
|--------------|-----------|--------|--------|-----------|--------|-----------|
| 효과성 | [Effectiveness KPI] | [Current] | [Target] | [주/월/분기] | [Owner] | [Audience] |
| 효율성 | [Efficiency KPI] | [Current] | [Target] | [주/월/분기] | [Owner] | [Audience] |
| 품질 | [Quality KPI] | [Current] | [Target] | [주/월/분기] | [Owner] | [Audience] |
| 만족도 | [Satisfaction KPI] | [Current] | [Target] | [주/월/분기] | [Owner] | [Audience] |

### 🎯 Critical Success Factors
1. **[성공 요인 1]**: [성공을 위한 핵심 조건]
2. **[성공 요인 2]**: [성공을 위한 핵심 조건]  
3. **[성공 요인 3]**: [성공을 위한 핵심 조건]

---
*이 분석은 바바라 민토의 피라미드 원리와 맥킨지 컨설팅 방법론을 기반으로 생성된 글로벌 컨설팅 펌 수준의 엘리트 분석 보고서입니다.*
`,

  logic_visualization: `
당신은 로직 시각화 전문가입니다. 제공된 미팅 내용에서 발생한 관점 차이, 갭 분석, 의사결정 과정을 논리적으로 시각화하여 분석해주세요.

## 로직 시각화 분석이란?
- **갭 맵핑**: 서로 다른 관점들의 차이점 시각화
- **의사결정 플로우**: 논의 과정과 결정 경로 분석
- **상호작용 분석**: 참가자 간 아이디어 교환 과정

다음 미팅 대화를 분석해주세요:

{MEETING_CONTENT}

# 미팅 분석 보고서 - 로직 시각화

## 📊 미팅 개요
- **분석 일시**: {CURRENT_DATE}
- **참석자**: [자동 추정]
- **주요 논의 주제**: [핵심 주제]

## 🎯 관점 차이 분석 (Gap Analysis)

### 참가자별 관점 매트릭스
| 주제/관점 | 참가자 A | 참가자 B | 차이점 | 합의점 |
|-----------|----------|----------|--------|--------|
| 주제 1 | [관점 A] | [관점 B] | [차이 분석] | [합의 내용] |
| 주제 2 | [관점 A] | [관점 B] | [차이 분석] | [합의 내용] |
| 주제 3 | [관점 A] | [관점 B] | [차이 분석] | [합의 내용] |

### 갭 해소 과정
1. **초기 갭 상태**: [처음 관점 차이]
2. **갭 인식 단계**: [차이점 발견 과정]  
3. **해결책 모색**: [절충안 탐색]
4. **합의 도출**: [최종 합의점]

## 🔄 의사결정 플로우

### 주요 결정 과정
\`\`\`
문제 인식 → 대안 탐색 → 평가 → 선택 → 실행 계획
    ↓           ↓         ↓      ↓        ↓
[구체적 내용] [옵션들] [기준] [결정] [계획]
\`\`\`

### 결정 요인 분석
- **결정적 요인**: [가장 중요했던 요소]
- **고려 요인**: [검토된 다른 요소들]
- **배제 요인**: [제외된 요소들]

## 💡 아이디어 발전 과정

### 아이디어 진화 맵
1. **초기 아이디어**: [처음 제시된 아이디어]
2. **발전 단계**: [아이디어가 발전된 과정]
3. **최종 형태**: [완성된 아이디어]

### 창의적 순간들
- [혁신적 아이디어가 나온 순간]
- [관점 전환이 일어난 지점]
- [솔루션 도출 과정]

## 🎯 상호작용 분석

### 커뮤니케이션 패턴
- **정보 공유**: [어떤 정보가 어떻게 공유되었나]
- **질문-응답**: [효과적인 질의응답 사례]
- **피드백 루프**: [의견 교환과 수정 과정]

### 참여도 분석
- **주도적 참여**: [적극적으로 참여한 부분]
- **수동적 참여**: [경청하며 참여한 부분]
- **상호 보완**: [서로 보완한 지점들]

## 📈 갭 해소 성과

### Before/After 비교
| 영역 | 미팅 전 | 미팅 후 | 개선도 |
|------|---------|---------|--------|
| 이해도 | [이전 상태] | [현재 상태] | [개선 정도] |
| 협력도 | [이전 상태] | [현재 상태] | [개선 정도] |
| 명확성 | [이전 상태] | [현재 상태] | [개선 정도] |

## 🔍 핵심 인사이트

### 성공 요인
1. **효과적이었던 접근법**: [잘 된 점]
2. **갭 해소 전략**: [차이를 좁힌 방법]
3. **합의 형성 과정**: [합의를 이룬 방식]

### 개선 기회
1. **더 탐색할 영역**: [추가 논의가 필요한 부분]
2. **프로세스 개선**: [다음 미팅 개선점]
3. **후속 조치**: [필요한 후속 작업]

## 🎯 실행 로드맵

### 단계별 실행 계획
\`\`\`
1단계 (즉시) → 2단계 (1주 내) → 3단계 (1개월 내)
     ↓              ↓               ↓
[즉시 조치]    [단기 목표]     [중기 목표]
\`\`\`

---
*이 분석은 로직 시각화 방법론을 기반으로 AI가 자동 생성한 것입니다.*
`,

  business_philosophy: `
당신은 사업철학 분석 전문가입니다. 제공된 미팅 내용을 Lv1(기술자), Lv2(관리자), Lv3(기업가) 관점으로 분류하고 분석해주세요.

## 3단계 사업철학 분류란?
- **Lv1 (기술자)**: 실행 중심, How 중심, 단기 (당일~3일)
- **Lv2 (관리자)**: 운영/조율 중심, What & Who, 중기 (1~4주)  
- **Lv3 (기업가)**: 전략/비전 중심, Why & 방향성, 장기 (1~6개월 이상)

다음 미팅 대화를 분석해주세요:

{MEETING_CONTENT}

# 미팅 분석 보고서 - 사업철학 Lv1~3 분류

## 📊 미팅 개요
- **분석 일시**: {CURRENT_DATE}
- **분석 관점**: 3단계 사업철학 (Lv1~Lv3)
- **참석자 역할**: [추정된 역할]

## 🎯 레벨별 분류 매트릭스

### Lv1: 기술자 관점 (Technician) - 실행 중심
#### 시간 범위: 당일~3일
#### 핵심 질문: "어떻게 할 것인가?"

**실행 중심 논의사항**:
- [구체적 작업 관련 논의]
- [즉시 실행 가능한 태스크]
- [기술적 세부사항]

**특징**:
- 현재에 집중, 구체적 결과물 중심
- 개별 작업의 완성도와 정확성 중시
- 즉각적인 문제 해결 지향

### Lv2: 관리자 관점 (Manager) - 조율 중심  
#### 시간 범위: 1주~4주
#### 핵심 질문: "무엇을 누가 할 것인가?"

**조율 중심 논의사항**:
- [팀 협업 및 프로세스]
- [리소스 배분 및 일정 관리]
- [프로젝트 진행 상황]

**특징**:
- 팀 단위 운영에 집중
- 시스템과 프로세스 최적화
- 안정적인 운영과 예측 가능성 추구

### Lv3: 기업가 관점 (Entrepreneur) - 비전 중심
#### 시간 범위: 1개월~6개월 이상  
#### 핵심 질문: "왜 하는가? 어떤 방향으로 가야 하나?"

**전략 중심 논의사항**:
- [장기 비전 및 전략]
- [시장 기회 및 혁신]
- [조직의 미래 방향성]

**특징**:
- 미래 지향적, 변화 주도
- 시장과 환경 변화에 대한 통찰
- 창의성과 위험 감수 중시

## 📈 레벨별 비중 분석

### 미팅 내용 분포
| 레벨 | 비중 | 주요 특징 | 개선 제안 |
|------|------|-----------|-----------|
| Lv1 (기술자) | [%] | [실행 관련 특징] | [개선 방향] |
| Lv2 (관리자) | [%] | [조율 관련 특징] | [개선 방향] |  
| Lv3 (기업가) | [%] | [전략 관련 특징] | [개선 방향] |

## 🔍 통합 분석

### 균형 분석
- **현재 균형**: [Lv1:Lv2:Lv3 비율]
- **이상적 균형**: [상황에 맞는 권장 비율]
- **조정 필요성**: [균형 개선 방안]

### 시너지 효과
- **Lv1↔Lv2 연결**: [실행과 관리의 연결점]
- **Lv2↔Lv3 연결**: [관리와 전략의 연결점]
- **Lv1↔Lv3 연결**: [실행과 비전의 연결점]

## 💡 레벨별 개선 제안

### Lv1 (기술자) 개선안
1. **실행력 강화**: [구체적 방법]
2. **효율성 증대**: [개선 방안]
3. **품질 관리**: [품질 향상 방법]

### Lv2 (관리자) 개선안  
1. **프로세스 최적화**: [체계화 방안]
2. **팀 협업 강화**: [협업 개선책]
3. **리소스 관리**: [자원 최적화]

### Lv3 (기업가) 개선안
1. **비전 명확화**: [방향성 설정]
2. **혁신 촉진**: [창새성 증진]
3. **전략 실행**: [전략의 실행 연결]

## 🎯 맥락별 레벨 분석

### 동일 주제의 다층적 접근
[같은 주제가 어떻게 다른 레벨에서 논의되었는지 분석]

### 상대적 분류 기준
- **시간 범위**: [단기 vs 중기 vs 장기]
- **시야 범위**: [개인 vs 팀 vs 조직]
- **의도 방향**: [해결 vs 설계 vs 방향]

## 📊 실행 로드맵

### 단계별 통합 계획
\`\`\`
Lv1 실행 → Lv2 시스템화 → Lv3 전략화
   ↓           ↓              ↓
[즉시 조치] [체계 구축]   [비전 실현]
\`\`\`

### 레벨 간 연결 고리
- [실행에서 시스템으로]
- [시스템에서 전략으로]  
- [전략에서 실행으로]

---
*이 분석은 3단계 사업철학 방법론을 기반으로 AI가 자동 생성한 것입니다.*
`
}

export async function POST(req: NextRequest) {
  try {
    // API 키 확인
    if (!process.env.ANTHROPIC_API_KEY || process.env.ANTHROPIC_API_KEY.startsWith('#')) {
      return NextResponse.json(
        { error: 'API 키가 설정되지 않았습니다. .env.local 파일에 ANTHROPIC_API_KEY를 설정해주세요.' },
        { status: 500 }
      )
    }

    const { meetingContent, templateType = 'three_levels_listening' } = await req.json()

    if (!meetingContent) {
      return NextResponse.json(
        { error: '미팅 내용이 제공되지 않았습니다.' },
        { status: 400 }
      )
    }

    // 템플릿 선택
    const selectedTemplate = ANALYSIS_TEMPLATES[templateType as keyof typeof ANALYSIS_TEMPLATES]
    
    if (!selectedTemplate) {
      return NextResponse.json(
        { error: '유효하지 않은 템플릿 타입입니다.' },
        { status: 400 }
      )
    }

    const prompt = selectedTemplate
      .replace('{MEETING_CONTENT}', meetingContent)
      .replace('{CURRENT_DATE}', new Date().toLocaleDateString('ko-KR'))

    const response = await anthropic.messages.create({
      model: 'claude-3-5-sonnet-20241022',
      max_tokens: 4000,
      messages: [
        {
          role: 'user',
          content: prompt
        }
      ]
    })

    const analysisResult = response.content[0].type === 'text' 
      ? response.content[0].text 
      : ''

    return NextResponse.json({
      success: true,
      analysis: analysisResult
    })

  } catch (error) {
    console.error('Analysis error:', error)
    return NextResponse.json(
      { error: '분석 중 오류가 발생했습니다.' },
      { status: 500 }
    )
  }
}